-- dnsdist configuration

-- Backend: Unbound
newServer({address="127.0.0.1:5353", name="unbound", qps=0, order=1, weight=1})

-- Listen on all interfaces
setLocal("0.0.0.0:53", {reusePort=true})
addLocal("[::]:53", {reusePort=true})

-- ACL (currently open)
-- Example local-only ACLs:
-- setACL({"127.0.0.0/8", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "::1/128", "fc00::/7"})
setACL({"0.0.0.0/0", "::/0"})

-- Cache (optimized)
pc = newPacketCache(200000, {
  maxTTL=86400,
  minTTL=60,
  temporaryFailureTTL=10,  -- Short TTL for SERVFAIL
  staleTTL=60              -- Serve stale on upstream failure
})
getPool(""):setCache(pc)

-- Rate limit (disabled for perf tests)
-- addAction(MaxQPSIPRule(100), DropAction())

-- Console
setKey("CHANGE_ME_TO_RANDOM_LONG_KEY")
controlSocket("127.0.0.1:5199")

-- =========================================================
-- DNSTAP logging (source of truth: dnsdist)
-- Allowlist (suffix) + NXDOMAIN always logged
-- Blocklist (suffix) returns REFUSED (allowlist overrides blocklist)
-- =========================================================

-- FrameStream logger (unix socket) with optimized queue sizes
local dnstapLogger = newFrameStreamUnixLogger("/run/dnsdist/dnstap.sock", {
  inputQueueSize=500000,
  outputQueueSize=500000,
  flushTimeout=1,
  bufferHint=1048576,
})

-- Load suffix list from file (supports *.example.com or .example.com or example.com)
local function loadSuffixList(path)
  local node = newSuffixMatchNode()
  local f = io.open(path, "r")
  if not f then
    print("WARN: could not open list file: " .. path)
    return node
  end

  for line in f:lines() do
    local s = line:gsub("^%s+", ""):gsub("%s+$", "")
    if s ~= "" and s:sub(1, 1) ~= "#" then
      if s:sub(1, 2) == "*." then
        s = s:sub(3)
      end
      if s:sub(1, 1) == "." then
        s = s:sub(2)
      end
      if s:sub(-1) ~= "." then
        s = s .. "."
      end

      local ok, dn = pcall(newDNSName, s)
      if ok then
        node:add(dn)
      end
    end
  end

  f:close()
  return node
end

local wl = loadSuffixList("/etc/dnsdist/allowlist.txt")
local bl = loadSuffixList("/etc/dnsdist/blocklist.txt")

-- Log rules:
-- 1) Log everything except allowlisted suffixes
local logRuleNormal = NotRule(SuffixMatchNodeRule(wl))

-- 2) Always log NXDOMAIN (even allowlisted)
local logRuleNX = RCodeRule(DNSRCode.NXDOMAIN)

-- 3) Final: not allowlisted OR NXDOMAIN
local logRuleFinal = OrRule({logRuleNormal, logRuleNX})

-- Query + Response log
addAction(logRuleFinal, DnstapLogAction("dnsdist", dnstapLogger))
addResponseAction(logRuleFinal, DnstapLogResponseAction("dnsdist", dnstapLogger))

-- Blocklist (allowlist overrides blocklist)
local blockRule = AndRule({NotRule(SuffixMatchNodeRule(wl)), SuffixMatchNodeRule(bl)})
addAction(blockRule, RCodeAction(DNSRCode.REFUSED))
