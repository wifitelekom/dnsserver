-- dnsdist configuration (FINAL)

-- Backend: Unbound
newServer({address="127.0.0.1:5353", name="unbound", qps=0, order=1, weight=1})

-- Listen on all interfaces
setLocal("0.0.0.0:53", {reusePort=true})
addLocal("[::]:53", {reusePort=true})

-- ACL (şimdilik açık)
setACL({"0.0.0.0/0", "::/0"})

-- Cache
pc = newPacketCache(100000, {maxTTL=86400, minTTL=60})
getPool(""):setCache(pc)

-- Rate limit (performans testi için kapalı)
-- addAction(MaxQPSIPRule(100), DropAction())

-- Console
setKey("CHANGE_ME_TO_RANDOM_LONG_KEY")
controlSocket("127.0.0.1:5199")

-- =========================================================
-- DNSTAP logging (source of truth: dnsdist)
-- Whitelist suffix filter + NXDOMAIN always logged
-- =========================================================

-- FrameStream logger (unix socket)
local dnstapLogger = newFrameStreamUnixLogger("/run/dnsdist/dnstap.sock", {
  -- İleride gerekirse:
  -- inputQueueSize=200000,
  -- outputQueueSize=200000,
  -- flushTimeout=1,
  -- bufferHint=1048576,
  -- connectionCount=1,
})

-- Whitelist suffix list (trailing dot ile)
local wl = newSuffixMatchNode()

-- Google / YouTube
wl:add(newDNSName("google.com."))
wl:add(newDNSName("youtube.com."))
wl:add(newDNSName("ytimg.com."))
wl:add(newDNSName("googleapis.com."))
wl:add(newDNSName("gstatic.com."))
wl:add(newDNSName("googleusercontent.com."))
wl:add(newDNSName("ggpht.com."))

-- Meta / WhatsApp / Instagram
wl:add(newDNSName("facebook.com."))
wl:add(newDNSName("fbcdn.net."))
wl:add(newDNSName("fbsbx.com."))
wl:add(newDNSName("instagram.com."))
wl:add(newDNSName("cdninstagram.com."))
wl:add(newDNSName("whatsapp.net."))

-- Telegram
wl:add(newDNSName("telegram.org."))
wl:add(newDNSName("t.me."))

-- Amazon / AWS
wl:add(newDNSName("amazon.com."))
wl:add(newDNSName("amazonaws.com."))
wl:add(newDNSName("cloudfront.net."))

-- Netflix
wl:add(newDNSName("netflix.com."))
wl:add(newDNSName("nflxvideo.net."))
wl:add(newDNSName("nflximg.net."))
wl:add(newDNSName("nflxext.com."))
wl:add(newDNSName("nflxso.net."))

-- Apple
wl:add(newDNSName("apple.com."))
wl:add(newDNSName("icloud.com."))
wl:add(newDNSName("mzstatic.com."))
wl:add(newDNSName("apple-dns.net."))

-- Microsoft
wl:add(newDNSName("microsoft.com."))
wl:add(newDNSName("windows.com."))
wl:add(newDNSName("windowsupdate.com."))
wl:add(newDNSName("office.com."))
wl:add(newDNSName("office365.com."))
wl:add(newDNSName("live.com."))
wl:add(newDNSName("outlook.com."))
wl:add(newDNSName("azure.com."))
wl:add(newDNSName("azureedge.net."))
wl:add(newDNSName("msedge.net."))

-- CDN / Infra
wl:add(newDNSName("cloudflare.com."))
wl:add(newDNSName("cloudflare-dns.com."))
wl:add(newDNSName("akamai.net."))
wl:add(newDNSName("akamaihd.net."))
wl:add(newDNSName("akamaized.net."))
wl:add(newDNSName("fastly.net."))
wl:add(newDNSName("fastlylb.net."))

-- Streaming / others (isteğe bağlı)
wl:add(newDNSName("spotify.com."))
wl:add(newDNSName("scdn.co."))
wl:add(newDNSName("twitch.tv."))
wl:add(newDNSName("ttvnw.net."))

-- Log rules:
-- 1) Whitelist dışı her şeyi logla
local logRuleNormal = NotRule(SuffixMatchNodeRule(wl))

-- 2) NXDOMAIN her zaman loglansın (whitelist dahil)
local logRuleNX = RCodeRule(DNSRCode.NXDOMAIN)

-- 3) Final: whitelist dışı OR NXDOMAIN
local logRuleFinal = OrRule({logRuleNormal, logRuleNX})

-- Query + Response log
addAction(logRuleFinal, DnstapLogAction("dnsdist", dnstapLogger))
addResponseAction(logRuleFinal, DnstapLogResponseAction("dnsdist", dnstapLogger))
