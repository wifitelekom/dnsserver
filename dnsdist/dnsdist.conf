-- dnsdist configuration
-- Goal (A): Allowlist’tekiler ASLA loglanmasın (NXDOMAIN dahil)
-- + Response logging kapalı
-- + Gürültü (reverse/PTR/DNS-SD vb) log dışı

-- =========================================================
-- Backend: Unbound
-- =========================================================
newServer({address="127.0.0.1:5353", name="unbound", qps=0, order=1, weight=1})

-- =========================================================
-- Listen
-- =========================================================
setLocal("0.0.0.0:53", {reusePort=true})
addLocal("[::]:53", {reusePort=true})

-- =========================================================
-- ACL (currently open)  -- DİKKAT: prod'da kapatmanı öneririm
-- =========================================================
-- setACL({"127.0.0.0/8", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "::1/128", "fc00::/7"})
setACL({"0.0.0.0/0", "::/0"})

-- =========================================================
-- Cache (optimized)
-- =========================================================
pc = newPacketCache(200000, {
  maxTTL=86400,
  minTTL=60,
  temporaryFailureTTL=10,  -- Short TTL for SERVFAIL
  staleTTL=60              -- Serve stale on upstream failure
})
getPool(""):setCache(pc)

-- =========================================================
-- Rate limit (disabled for perf tests)
-- =========================================================
-- addAction(MaxQPSIPRule(100), DropAction())

-- =========================================================
-- Console / API
-- =========================================================
setKey("TO1DqGuKx2WWsOdxQtcgGnzRbnfY654jI9O5Kxpv/mxLizpX2A7W0Wiur6o517kv")
controlSocket("127.0.0.1:5199")
webserver("127.0.0.1:8083")
setWebserverConfig({password="supersecretpassword", apiKey="supersecretAPIkey"})

-- =========================================================
-- DNSTAP logging (source of truth: dnsdist)
-- Allowlist (suffix/wildcard) => ASLA loglanmaz (NXDOMAIN dahil)
-- Blocklist (suffix/wildcard) => REFUSED (allowlist overrides)
-- Gürültü (noise) => loglanmaz
-- =========================================================

-- FrameStream logger (unix socket)
local dnstapLogger = newFrameStreamUnixLogger("/run/dnsdist/dnstap.sock")

-- ---------------------------------------------------------
-- Helpers: Load suffix list from file
-- Supports:
-- - example.com
-- - *.example.com
-- - .example.com
-- ---------------------------------------------------------
local function loadSuffixList(path)
  local node = newSuffixMatchNode()
  local f = io.open(path, "r")
  if not f then
    print("WARN: could not open list file: " .. path)
    return node
  end

  for line in f:lines() do
    local s = line:gsub("^%s+", ""):gsub("%s+$", "")
    if s ~= "" and s:sub(1, 1) ~= "#" then
      if s:sub(1, 2) == "*." then
        s = s:sub(3)
      end
      if s:sub(1, 1) == "." then
        s = s:sub(2)
      end
      if s:sub(-1) ~= "." then
        s = s .. "."
      end

      local ok, dn = pcall(newDNSName, s)
      if ok then
        node:add(dn)
      end
    end
  end

  f:close()
  return node
end

-- Lists
local wl = loadSuffixList("/etc/dnsdist/allowlist.txt")
local bl = loadSuffixList("/etc/dnsdist/blocklist.txt")

-- “Noise” (loglamak istemediğin gürültü suffix’leri)
-- Örn dosya: /etc/dnsdist/noiselist.txt
-- in-addr.arpa
-- ip6.arpa
-- _dns-sd._udp
-- local
local nl = loadSuffixList("/etc/dnsdist/noiselist.txt")

-- ---------------------------------------------------------
-- Logging rules
-- A hedefi: logla = (NOT allowlisted) AND (NOT noise)
-- NXDOMAIN özel durumu YOK -> allowlist her koşulda susar
-- ---------------------------------------------------------
local notAllowlisted = NotRule(SuffixMatchNodeRule(wl))
local notNoise       = NotRule(SuffixMatchNodeRule(nl))

local logRuleFinal = AndRule({notAllowlisted, notNoise})

-- Query log (response logging KAPALI)
addAction(logRuleFinal, DnstapLogAction("dnsdist", dnstapLogger))
-- addResponseAction(logRuleFinal, DnstapLogResponseAction("dnsdist", dnstapLogger))  -- kapalı

-- ---------------------------------------------------------
-- Blocklist (allowlist overrides blocklist)
-- Yani allowlist'te olan bir şey blocklist'te olsa bile engellenmez.
-- ---------------------------------------------------------
local blockRule = AndRule({NotRule(SuffixMatchNodeRule(wl)), SuffixMatchNodeRule(bl)})
addAction(blockRule, RCodeAction(DNSRCode.REFUSED))
